# ===================================
# CONFIGURATION NGINX - PORTFOLIO KELTZ MARIUS
# web.primegaming.freedns.org
# ===================================

# Cette configuration est à utiliser dans NPM (Nginx Proxy Manager)
# ou dans votre configuration Nginx directe

server {
    listen 80;
    server_name web.primegaming.freedns.org;
    
    # Redirection automatique vers HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name web.primegaming.freedns.org;
    
    # Chemin vers votre portfolio (à adapter)
    root /var/www/portfolio;
    index index.html;
    
    # ===================================
    # CERTIFICATS SSL (Let's Encrypt)
    # ===================================
    # Ces chemins sont gérés automatiquement par NPM
    # Si vous utilisez NPM, ces lignes sont déjà configurées
    # ssl_certificate /etc/letsencrypt/live/web.primegaming.freedns.org/fullchain.pem;
    # ssl_certificate_key /etc/letsencrypt/live/web.primegaming.freedns.org/privkey.pem;
    
    # Paramètres SSL modernes
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    ssl_stapling on;
    ssl_stapling_verify on;
    
    # ===================================
    # HEADERS DE SÉCURITÉ
    # ===================================
    # À ajouter dans NPM > Proxy Host > Advanced > Custom Nginx Configuration
    
    # Protection XSS
    add_header X-XSS-Protection "1; mode=block" always;
    
    # Protection Clickjacking
    add_header X-Frame-Options "SAMEORIGIN" always;
    
    # Empêcher le MIME sniffing
    add_header X-Content-Type-Options "nosniff" always;
    
    # Politique de référent
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # Permissions Policy
    add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=(), magnetometer=(), gyroscope=()" always;
    
    # Content Security Policy
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://formsubmit.co; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; img-src 'self' data: https:; font-src 'self' https://cdnjs.cloudflare.com data:; connect-src 'self' https://formsubmit.co; frame-ancestors 'self'; base-uri 'self'; form-action 'self' https://formsubmit.co;" always;
    
    # HSTS (Force HTTPS pendant 1 an)
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
    
    # Cacher la version Nginx
    server_tokens off;
    
    # ===================================
    # RATE LIMITING
    # ===================================
    # À ajouter au niveau HTTP (avant le bloc server)
    
    # Zone de limitation générale (10 requêtes par seconde)
    limit_req_zone $binary_remote_addr zone=general:10m rate=10r/s;
    
    # Zone de limitation API/Formulaire (3 requêtes par minute)
    limit_req_zone $binary_remote_addr zone=contact:10m rate=3r/m;
    
    # Limitation de connexions simultanées
    limit_conn_zone $binary_remote_addr zone=addr:10m;
    
    # Appliquer les limites
    limit_req zone=general burst=20 nodelay;
    limit_conn addr 10;
    
    # ===================================
    # TIMEOUTS ET BUFFERS
    # ===================================
    
    # Protection contre Slowloris
    client_body_timeout 10s;
    client_header_timeout 10s;
    keepalive_timeout 5s;
    send_timeout 10s;
    
    # Limiter la taille des requêtes
    client_max_body_size 10M;
    client_body_buffer_size 128k;
    client_header_buffer_size 1k;
    large_client_header_buffers 4 4k;
    
    # ===================================
    # LOCATIONS ET RÈGLES
    # ===================================
    
    # Page d'accueil
    location / {
        try_files $uri $uri/ =404;
        
        # Headers cache pour HTML
        add_header Cache-Control "no-cache, must-revalidate" always;
    }
    
    # Rate limiting strict pour formulaire de contact
    location = /contact {
        limit_req zone=contact burst=2 nodelay;
        try_files $uri $uri/ =404;
    }
    
    # Cache agressif pour les assets statiques
    location ~* \.(jpg|jpeg|png|gif|ico|svg|webp|css|js|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }
    
    # Bloquer l'accès aux fichiers sensibles
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    location ~ \.(git|env|log|sql|bak|config|ini|md)$ {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    # Bloquer l'accès aux fichiers PHP dans assets (si jamais)
    location ~* ^/assets/.*\.php$ {
        deny all;
        access_log off;
        log_not_found off;
    }
    
    # ===================================
    # BLOCAGE DES BOTS MALVEILLANTS
    # ===================================
    
    # Bloquer les user agents suspects
    if ($http_user_agent ~* (libwww|wget|curl|python|java|winhttp|HTTrack|clshttp|archiver|loader|nikto|sqlmap|webshag|brutus)) {
        return 403 "Bot Blocked";
    }
    
    # Bloquer les requêtes sans user agent
    if ($http_user_agent = "") {
        return 403 "No User Agent";
    }
    
    # ===================================
    # GÉOBLOCAGE (optionnel)
    # ===================================
    # Nécessite ngx_http_geoip_module
    
    # geoip_country /usr/share/GeoIP/GeoIP.dat;
    # 
    # map $geoip_country_code $allowed_country {
    #     default no;
    #     FR yes;
    #     BE yes;
    #     CH yes;
    #     LU yes;
    #     DE yes;
    # }
    # 
    # if ($allowed_country = no) {
    #     return 403 "Access Denied - Geographic Restriction";
    # }
    
    # ===================================
    # PROTECTION HOTLINKING
    # ===================================
    
    location ~* \.(jpg|jpeg|png|gif|svg|webp)$ {
        valid_referers none blocked server_names web.primegaming.freedns.org;
        if ($invalid_referer) {
            return 403 "Hotlinking Not Allowed";
        }
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # ===================================
    # PAGES D'ERREUR PERSONNALISÉES
    # ===================================
    
    error_page 403 /403.html;
    error_page 404 /404.html;
    error_page 500 502 503 504 /50x.html;
    
    # ===================================
    # LOGS
    # ===================================
    
    access_log /var/log/nginx/portfolio_access.log;
    error_log /var/log/nginx/portfolio_error.log warn;
}

# ===================================
# CONFIGURATION POUR NPM (Custom Nginx Configuration)
# ===================================
# Copier cette partie dans NPM > Proxy Host > Advanced > Custom Nginx Configuration
# ===================================

# Headers de sécurité
add_header X-XSS-Protection "1; mode=block" always;
add_header X-Frame-Options "SAMEORIGIN" always;
add_header X-Content-Type-Options "nosniff" always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;
add_header Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=(), magnetometer=(), gyroscope=()" always;
add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://formsubmit.co; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; img-src 'self' data: https:; font-src 'self' https://cdnjs.cloudflare.com data:; connect-src 'self' https://formsubmit.co; frame-ancestors 'self'; base-uri 'self'; form-action 'self' https://formsubmit.co;" always;
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;

# Cacher version serveur
server_tokens off;

# Rate limiting
limit_req_zone $binary_remote_addr zone=general:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=contact:10m rate=3r/m;
limit_conn_zone $binary_remote_addr zone=addr:10m;

limit_req zone=general burst=20 nodelay;
limit_conn addr 10;

# Timeouts
client_body_timeout 10s;
client_header_timeout 10s;
keepalive_timeout 5s;
send_timeout 10s;

# Buffers
client_max_body_size 10M;
client_body_buffer_size 128k;

# Bloquer fichiers sensibles
location ~ /\. { deny all; }
location ~ \.(git|env|log|sql|bak|config|ini|md)$ { deny all; }

# Bloquer bots malveillants
if ($http_user_agent ~* (libwww|wget|curl|python|java|winhttp|HTTrack|clshttp|archiver|loader|nikto|sqlmap|webshag|brutus)) {
    return 403;
}
if ($http_user_agent = "") {
    return 403;
}
