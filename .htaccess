# ===================================
# CONFIGURATION DE SÉCURITÉ - PORTFOLIO KELTZ MARIUS
# Pour serveur Apache
# ===================================

# ===================================
# 1. HEADERS DE SÉCURITÉ
# ===================================

<IfModule mod_headers.c>
    # Protection XSS
    Header set X-XSS-Protection "1; mode=block"
    
    # Empêcher l'embedding dans des iframes (protection clickjacking)
    Header set X-Frame-Options "SAMEORIGIN"
    
    # Empêcher le MIME type sniffing
    Header set X-Content-Type-Options "nosniff"
    
    # Politique de référent
    Header set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Permissions Policy (anciennement Feature-Policy)
    Header set Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=(), magnetometer=(), gyroscope=()"
    
    # Content Security Policy
    Header set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com https://formsubmit.co; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; img-src 'self' data: https:; font-src 'self' https://cdnjs.cloudflare.com data:; connect-src 'self' https://formsubmit.co; frame-ancestors 'self'; base-uri 'self'; form-action 'self' https://formsubmit.co;"
    
    # HSTS - Force HTTPS (décommenter après avoir configuré HTTPS)
    # Header set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    
    # Cacher la version du serveur
    Header unset X-Powered-By
    Header unset Server
</IfModule>

# ===================================
# 2. FORCE HTTPS (décommenter après configuration SSL)
# ===================================

# <IfModule mod_rewrite.c>
#     RewriteEngine On
#     RewriteCond %{HTTPS} off
#     RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
# </IfModule>

# ===================================
# 3. PROTECTION DES FICHIERS SENSIBLES
# ===================================

# Bloquer l'accès aux fichiers sensibles
<FilesMatch "\.(git|gitignore|env|log|md|sql|bak|config|ini)$">
    Require all denied
</FilesMatch>

# Bloquer l'accès aux dossiers .git
RedirectMatch 404 /\.git

# Désactiver le listing des répertoires
Options -Indexes

# Protection du fichier .htaccess lui-même
<Files .htaccess>
    Require all denied
</Files>

# ===================================
# 4. LIMITATION DES MÉTHODES HTTP
# ===================================

<IfModule mod_rewrite.c>
    RewriteEngine On
    # Autoriser seulement GET, POST, HEAD
    RewriteCond %{REQUEST_METHOD} !^(GET|POST|HEAD)$
    RewriteRule .* - [F,L]
</IfModule>

# ===================================
# 5. PROTECTION CONTRE LES INJECTIONS
# ===================================

<IfModule mod_rewrite.c>
    RewriteEngine On
    
    # Bloquer les tentatives d'injection SQL
    RewriteCond %{QUERY_STRING} (\<|%3C).*script.*(\>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} GLOBALS(=|\[|\%[0-9A-Z]{0,2}) [OR]
    RewriteCond %{QUERY_STRING} _REQUEST(=|\[|\%[0-9A-Z]{0,2}) [OR]
    RewriteCond %{QUERY_STRING} (\<|%3C).*iframe.*(\>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} (.*)(union|select|insert|drop|update|delete|replace|truncate|from|where)(.*) [NC,OR]
    RewriteCond %{QUERY_STRING} (\.\./|\.\.\\) [NC,OR]
    RewriteCond %{QUERY_STRING} (javascript|vbscript|base64|eval|expression)\( [NC]
    RewriteRule ^(.*)$ - [F,L]
    
    # Bloquer l'accès aux fichiers PHP dans les dossiers d'upload
    RewriteCond %{REQUEST_URI} ^/assets/.*\.php$ [NC]
    RewriteRule .* - [F,L]
</IfModule>

# ===================================
# 6. LIMITATION DES UPLOADS
# ===================================

<IfModule mod_php7.c>
    php_value upload_max_filesize 10M
    php_value post_max_size 10M
    php_value max_execution_time 300
    php_value max_input_time 300
</IfModule>

# ===================================
# 7. COMPRESSION ET PERFORMANCE
# ===================================

<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/x-javascript application/json
</IfModule>

# ===================================
# 8. MISE EN CACHE
# ===================================

<IfModule mod_expires.c>
    ExpiresActive On
    
    # Images
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType image/webp "access plus 1 year"
    ExpiresByType image/x-icon "access plus 1 year"
    
    # CSS et JavaScript
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType text/javascript "access plus 1 month"
    
    # Fonts
    ExpiresByType font/woff2 "access plus 1 year"
    ExpiresByType font/woff "access plus 1 year"
    ExpiresByType font/ttf "access plus 1 year"
    ExpiresByType application/font-woff2 "access plus 1 year"
    
    # HTML
    ExpiresByType text/html "access plus 0 seconds"
</IfModule>

# ===================================
# 9. GÉOBLOCAGE (optionnel - nécessite mod_geoip)
# ===================================

# <IfModule mod_geoip.c>
#     GeoIPEnable On
#     # Autoriser seulement France, Belgique, Suisse, Luxembourg, Allemagne
#     SetEnvIf GEOIP_COUNTRY_CODE FR AllowCountry
#     SetEnvIf GEOIP_COUNTRY_CODE BE AllowCountry
#     SetEnvIf GEOIP_COUNTRY_CODE CH AllowCountry
#     SetEnvIf GEOIP_COUNTRY_CODE LU AllowCountry
#     SetEnvIf GEOIP_COUNTRY_CODE DE AllowCountry
#     
#     Deny from all
#     Allow from env=AllowCountry
# </IfModule>

# ===================================
# 10. BLOQUER LES USER AGENTS MALVEILLANTS
# ===================================

<IfModule mod_rewrite.c>
    RewriteEngine On
    
    # Bloquer les bots malveillants connus
    RewriteCond %{HTTP_USER_AGENT} ^$ [OR]
    RewriteCond %{HTTP_USER_AGENT} (libwww|wget|curl|python|java|winhttp|HTTrack|clshttp|archiver|loader|nikto|sqlmap|webshag|brutus) [NC,OR]
    RewriteCond %{HTTP_USER_AGENT} (<|>|'|%0A|%0D|%27|%3C|%3E|%00) [NC]
    RewriteRule .* - [F,L]
</IfModule>

# ===================================
# 11. PROTECTION HOTLINKING
# ===================================

<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteCond %{HTTP_REFERER} !^$
    RewriteCond %{HTTP_REFERER} !^https?://(www\.)?web\.primegaming\.freedns\.org [NC]
    RewriteRule \.(jpg|jpeg|png|gif|svg|webp)$ - [F,L]
</IfModule>

# ===================================
# FIN DE LA CONFIGURATION
# ===================================
